From bbc99c0cb5c674389876a11f6f1788c867bb4fea Mon Sep 17 00:00:00 2001
From: =?UTF-8?q?Daniel=20P=2E=20Berrang=C3=A9?= <berrange@redhat.com>
Date: Wed, 9 May 2018 09:06:29 +0100
Subject: [PATCH v3 1/5] i386: define the 'ssbd' CPUID feature bit
 (CVE-2018-3639)
MIME-Version: 1.0
Content-Type: text/plain; charset=UTF-8
Content-Transfer-Encoding: 8bit

New microcode introduces the "Speculative Store Bypass Disable"
CPUID feature bit. This needs to be exposed to guest OS to allow
them to protect against CVE-2018-3639.

Signed-off-by: Daniel P. Berrang√© <berrange@redhat.com>
Reviewed-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
Signed-off-by: Konrad Rzeszutek Wilk <konrad.wilk@oracle.com>
---
 target/i386/cpu.c | 2 +-
 target/i386/cpu.h | 1 +
 2 files changed, 2 insertions(+), 1 deletion(-)

Index: qemu-2.11+dfsg/target/i386/cpu.c
===================================================================
--- qemu-2.11+dfsg.orig/target/i386/cpu.c	2018-05-18 14:06:13.147016560 -0400
+++ qemu-2.11+dfsg/target/i386/cpu.c	2018-05-18 14:06:13.143016565 -0400
@@ -459,7 +459,7 @@ static FeatureWordInfo feature_word_info
             NULL, NULL, NULL, NULL,
             NULL, NULL, NULL, NULL,
             NULL, NULL, "spec-ctrl", NULL,
-            NULL, NULL, NULL, NULL,
+            NULL, NULL, NULL, "ssbd",
         },
         .cpuid_eax = 7,
         .cpuid_needs_ecx = true, .cpuid_ecx = 0,
Index: qemu-2.11+dfsg/target/i386/cpu.h
===================================================================
--- qemu-2.11+dfsg.orig/target/i386/cpu.h	2018-05-18 14:06:13.147016560 -0400
+++ qemu-2.11+dfsg/target/i386/cpu.h	2018-05-18 14:06:13.143016565 -0400
@@ -650,6 +650,7 @@ typedef uint32_t FeatureWordArray[FEATUR
 #define CPUID_7_0_EDX_AVX512_4VNNIW (1U << 2) /* AVX512 Neural Network Instructions */
 #define CPUID_7_0_EDX_AVX512_4FMAPS (1U << 3) /* AVX512 Multiply Accumulation Single Precision */
 #define CPUID_7_0_EDX_SPEC_CTRL     (1U << 26) /* Speculation Control */
+#define CPUID_7_0_EDX_SPEC_CTRL_SSBD  (1U << 31) /* Speculative Store Bypass Disable */
 
 #define CPUID_8000_0008_EBX_IBPB    (1U << 12) /* Indirect Branch Prediction Barrier */
 
